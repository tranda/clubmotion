<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Multi-Year Payment CSV Splitter</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 1200px;
            margin: 50px auto;
            padding: 20px;
            background: #f5f5f5;
        }
        .container {
            background: white;
            padding: 30px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        h1 {
            color: #333;
            margin-bottom: 20px;
        }
        .info {
            background: #e3f2fd;
            padding: 15px;
            border-radius: 4px;
            margin-bottom: 20px;
            border-left: 4px solid #2196f3;
        }
        .upload-area {
            border: 2px dashed #ccc;
            padding: 40px;
            text-align: center;
            border-radius: 4px;
            margin-bottom: 20px;
            cursor: pointer;
        }
        .upload-area:hover {
            border-color: #2196f3;
            background: #f0f8ff;
        }
        input[type="file"] {
            display: none;
        }
        button {
            background: #2196f3;
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 16px;
            margin: 5px;
        }
        button:hover {
            background: #1976d2;
        }
        button:disabled {
            background: #ccc;
            cursor: not-allowed;
        }
        .output {
            margin-top: 20px;
        }
        .year-section {
            background: #f9f9f9;
            padding: 15px;
            margin: 10px 0;
            border-radius: 4px;
            border-left: 4px solid #4caf50;
        }
        .success {
            color: #4caf50;
            font-weight: bold;
        }
        pre {
            background: #f5f5f5;
            padding: 10px;
            border-radius: 4px;
            overflow-x: auto;
            font-size: 12px;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>üìä Multi-Year Payment CSV Splitter</h1>

        <div class="info">
            <strong>üìù Instructions:</strong>
            <ol>
                <li>Export your Excel sheet as CSV (File ‚Üí Save As ‚Üí CSV UTF-8)</li>
                <li>Upload the CSV file below</li>
                <li>Select which years to process (2022-2025)</li>
                <li>Download individual year CSV files</li>
                <li>Import each year separately in ClubMotion</li>
            </ol>
        </div>

        <div class="upload-area" id="uploadArea">
            <input type="file" id="fileInput" accept=".csv" />
            <p style="font-size: 18px; margin: 0;">üìÅ Click to upload your multi-year CSV file</p>
            <p style="color: #666; margin-top: 10px;">or drag and drop here</p>
        </div>

        <div id="yearSelection" style="display: none; margin-bottom: 20px;">
            <h3>Select Years to Process:</h3>
            <label style="margin-right: 15px;">
                <input type="checkbox" id="year2022" value="2022"> 2022 (treat "free" as exempt)
            </label>
            <label style="margin-right: 15px;">
                <input type="checkbox" id="year2023" value="2023" checked> 2023
            </label>
            <label style="margin-right: 15px;">
                <input type="checkbox" id="year2024" value="2024" checked> 2024
            </label>
            <label style="margin-right: 15px;">
                <input type="checkbox" id="year2025" value="2025" checked> 2025
            </label>
            <br><br>
            <button id="processBtn">üîÑ Process CSV</button>
        </div>

        <div id="output" class="output"></div>
    </div>

    <script>
        let csvData = null;
        const fileInput = document.getElementById('fileInput');
        const uploadArea = document.getElementById('uploadArea');
        const yearSelection = document.getElementById('yearSelection');
        const processBtn = document.getElementById('processBtn');
        const output = document.getElementById('output');

        uploadArea.addEventListener('click', () => fileInput.click());

        uploadArea.addEventListener('dragover', (e) => {
            e.preventDefault();
            uploadArea.style.borderColor = '#2196f3';
        });

        uploadArea.addEventListener('dragleave', () => {
            uploadArea.style.borderColor = '#ccc';
        });

        uploadArea.addEventListener('drop', (e) => {
            e.preventDefault();
            uploadArea.style.borderColor = '#ccc';
            const file = e.dataTransfer.files[0];
            if (file) handleFile(file);
        });

        fileInput.addEventListener('change', (e) => {
            const file = e.target.files[0];
            if (file) handleFile(file);
        });

        function handleFile(file) {
            const reader = new FileReader();
            reader.onload = (e) => {
                csvData = e.target.result;
                uploadArea.innerHTML = `<p class="success">‚úì File loaded: ${file.name}</p>`;
                yearSelection.style.display = 'block';
            };
            reader.readAsText(file);
        }

        processBtn.addEventListener('click', () => {
            if (!csvData) return alert('Please upload a CSV file first');

            const selectedYears = [];
            if (document.getElementById('year2022').checked) selectedYears.push('2022');
            if (document.getElementById('year2023').checked) selectedYears.push('2023');
            if (document.getElementById('year2024').checked) selectedYears.push('2024');
            if (document.getElementById('year2025').checked) selectedYears.push('2025');

            if (selectedYears.length === 0) {
                return alert('Please select at least one year');
            }

            processCSV(selectedYears);
        });

        function processCSV(years) {
            const lines = csvData.split('\n');
            const headers = lines[0].split('\t');

            const monthMap = {
                'JAN': 'JAN', 'FEB': 'FEB', 'MAR': 'MAR', 'APR': 'APR',
                'MAJ': 'MAY', 'JUN': 'JUN', 'JUL': 'JUL', 'AUG': 'AUG',
                'SEP': 'SEP', 'OKT': 'OCT', 'NOV': 'NOV', 'DEC': 'DEC',
                'jAN': 'JAN', 'fEB': 'FEB', 'mAR': 'MAR', 'aPR': 'APR',
                'mAJ': 'MAY', 'jUN': 'JUN', 'jUL': 'JUL', 'aUG': 'AUG',
                'sEP': 'SEP', 'oKT': 'OCT', 'nOV': 'NOV', 'dEC': 'DEC'
            };

            output.innerHTML = '<h2>üì¶ Generated CSV Files:</h2>';

            years.forEach(year => {
                const yearData = [];
                const yearHeader = ['Email', 'Membership_Number'];

                // Build header for this year
                for (let month of ['JAN', 'FEB', 'MAR', 'APR', 'MAY', 'JUN', 'JUL', 'AUG', 'SEP', 'OCT', 'NOV', 'DEC']) {
                    yearHeader.push(`${month}_${year}`);
                }

                // Find column indices for this year
                const yearColumns = {};
                headers.forEach((header, index) => {
                    const cleaned = header.trim();
                    const match = cleaned.match(/^(.*?)\s*(\d{4})$/);
                    if (match) {
                        const [, monthPart, yr] = match;
                        if (yr === year && monthMap[monthPart]) {
                            yearColumns[monthMap[monthPart]] = index;
                        }
                    }
                });

                // Process each member row
                for (let i = 1; i < lines.length; i++) {
                    if (!lines[i].trim()) continue;

                    const cells = lines[i].split('\t');
                    const membershipNumber = cells[0]?.trim();
                    const email = cells[1]?.trim();

                    if (!membershipNumber) continue;

                    const row = [email || '', membershipNumber];

                    // Extract data for each month
                    for (let month of ['JAN', 'FEB', 'MAR', 'APR', 'MAY', 'JUN', 'JUL', 'AUG', 'SEP', 'OCT', 'NOV', 'DEC']) {
                        const colIndex = yearColumns[month];
                        let value = colIndex !== undefined ? cells[colIndex]?.trim() : '';

                        // Handle "free" from 2022
                        if (value === 'free') {
                            value = 'exempt';
                        }

                        row.push(value || '');
                    }

                    yearData.push(row);
                }

                // Generate CSV content
                let csvContent = yearHeader.join(',') + '\n';
                yearData.forEach(row => {
                    csvContent += row.map(cell => {
                        // Escape cells with commas
                        if (cell.includes(',')) {
                            return `"${cell}"`;
                        }
                        return cell;
                    }).join(',') + '\n';
                });

                // Create download
                const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
                const url = URL.createObjectURL(blob);

                const yearSection = document.createElement('div');
                yearSection.className = 'year-section';
                yearSection.innerHTML = `
                    <h3>Year ${year}</h3>
                    <p>Records: ${yearData.length} members</p>
                    <button onclick="downloadFile('${url}', 'payments_${year}.csv')">
                        ‚¨áÔ∏è Download payments_${year}.csv
                    </button>
                    <details style="margin-top: 10px;">
                        <summary style="cursor: pointer; color: #2196f3;">Preview first 3 rows</summary>
                        <pre>${csvContent.split('\n').slice(0, 4).join('\n')}</pre>
                    </details>
                `;
                output.appendChild(yearSection);
            });

            output.innerHTML += `
                <div class="info" style="margin-top: 20px;">
                    <strong>‚úÖ Next Steps:</strong>
                    <ol>
                        <li>Download all generated CSV files</li>
                        <li>Go to ClubMotion ‚Üí Payments ‚Üí Import CSV</li>
                        <li>Import each year separately (start with oldest year first)</li>
                        <li>Verify the data in the payment grid</li>
                    </ol>
                </div>
            `;
        }

        function downloadFile(url, filename) {
            const a = document.createElement('a');
            a.href = url;
            a.download = filename;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
        }
    </script>
</body>
</html>
